openapi: 3.0.3
info:
  title: E-Signer API
  version: 1.0.0
  description: |
    Dokumentasi OpenAPI untuk layanan E-Signer multi-tenant.
    Central API berada di /api, sedangkan Tenant API berada di /{tenant}/api.
servers:
  - url: http://13.229.151.205/api
    description: Central API
  - url: http://13.229.151.205/{tenant}/api
    example use : http://13.229.151.205/nusanett/api
    description: Tenant API
    variables:
      tenant:
        default: demo
        description: Tenant slug atau tenant ID (ULID).
tags:
  - name: Central
    description: Endpoint central (registrasi tenant).
  - name: Public
    description: Endpoint tenant yang tidak membutuhkan auth.
  - name: Auth
    description: Auth dan profil user.
  - name: Documents
    description: Signing dan versi dokumen.
  - name: Verify
    description: Verifikasi dokumen bertanda tangan.
paths:
  /tenants/register:
    post:
      tags: [Central]
      summary: Register tenant dan user pertama
      description: |
        Membuat tenant baru sekaligus user pertama (testing/dev).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterTenantRequest"
            examples:
              default:
                value:
                  tenantName: Demo Company
                  tenantSlug: demo
                  name: Rifqi Yafik
                  email: rifqi@domain.com
                  password: secret123
                  password_confirmation: secret123
                  role: Direktur
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterTenantResponse"
        "409":
          description: Conflict (email sudah terdaftar)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
  /public/info:
    get:
      tags: [Public]
      summary: Tenant public info
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantInfoResponse"
  /auth/register:
    post:
      tags: [Auth]
      summary: Register user tenant
      description: |
        Membuat user tenant sekaligus certificate dan mengembalikan access token.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRegisterRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "409":
          description: Conflict (email sudah terdaftar)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
  /auth/login:
    post:
      tags: [Auth]
      summary: Login user tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLoginRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Unauthorized (credential salah)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
  /auth/me:
    get:
      tags: [Auth]
      summary: Profil user tenant
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /documents/sign:
    post:
      tags: [Documents]
      summary: Sign dokumen PDF
      description: |
        Menerima PDF (bisa sudah ditandatangani) dan membuat versi baru.
        QR (tanpa teks) ditanam di halaman terakhir.
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/IdempotencyKeyHeader"
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file, consent]
              properties:
                file:
                  type: string
                  format: binary
                consent:
                  type: boolean
                  description: Harus true.
                idempotencyKey:
                  type: string
                  description: Optional, setara dengan header Idempotency-Key.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DocumentSignResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
  /documents/{documentId}:
    get:
      tags: [Documents]
      summary: Detail dokumen
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/DocumentId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DocumentShowResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /documents/{documentId}/versions:
    get:
      tags: [Documents]
      summary: List versi dokumen
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/DocumentId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DocumentVersionsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /documents/{documentId}/versions/latest:download:
    get:
      tags: [Documents]
      summary: Download versi terbaru
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/DocumentId"
      responses:
        "200":
          description: PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /documents/{documentId}/versions/v{version}:download:
    get:
      tags: [Documents]
      summary: Download versi tertentu
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/DocumentId"
        - $ref: "#/components/parameters/Version"
      responses:
        "200":
          description: PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /verify:
    post:
      tags: [Verify]
      summary: Verifikasi PDF (upload)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerifyResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
  /verify/{chainId}/v{version}:
    get:
      tags: [Verify]
      summary: Verifikasi via chainId dan version
      parameters:
        - $ref: "#/components/parameters/ChainId"
        - $ref: "#/components/parameters/Version"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerifyResponse"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      tags: [Verify]
      summary: Verifikasi file PDF terhadap chainId + version
      parameters:
        - $ref: "#/components/parameters/ChainId"
        - $ref: "#/components/parameters/Version"
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VerifyResponse"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /pki/root-ca:
    get:
      tags: [Verify]
      summary: Root CA publik
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  certificate:
                    type: string
                  fingerprint:
                    type: string
                  subject:
                    type: string
                  validFrom:
                    type: string
                  validTo:
                    type: string
  /pki/certificates/me:
    get:
      tags: [Auth]
      summary: Detail sertifikat user aktif
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserCertificateResponse"
        "404":
          description: Not Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /pki/certificates/me/enroll:
    post:
      tags: [Auth]
      summary: Enroll sertifikat user (buat baru jika belum ada / revoked)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserCertificateResponse"
  /pki/certificates/me/renew:
    post:
      tags: [Auth]
      summary: Perbarui sertifikat user (rotasi key)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserCertificateResponse"
  /pki/certificates/me/revoke:
    post:
      tags: [Auth]
      summary: Cabut sertifikat user
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserCertificateResponse"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    DocumentId:
      name: documentId
      in: path
      required: true
      schema:
        type: string
      description: ID dokumen.
    ChainId:
      name: chainId
      in: path
      required: true
      schema:
        type: string
      description: ID rantai dokumen.
    Version:
      name: version
      in: path
      required: true
      schema:
        type: integer
      description: Nomor versi dokumen.
    IdempotencyKeyHeader:
      name: Idempotency-Key
      in: header
      required: false
      schema:
        type: string
      description: Kunci idempotency untuk mencegah versi duplikat.
  schemas:
    RegisterTenantRequest:
      type: object
      required: [tenantName, name, email, password, password_confirmation]
      properties:
        tenantName:
          type: string
        tenantSlug:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 8
        password_confirmation:
          type: string
          format: password
        role:
          type: string
          description: Default owner.
    RegisterTenantResponse:
      type: object
      properties:
        accessToken:
          type: string
        tenantId:
          type: string
        tenantSlug:
          type: string
        userId:
          type: string
    AuthRegisterRequest:
      type: object
      required: [name, email, password, password_confirmation]
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 8
        password_confirmation:
          type: string
          format: password
    AuthLoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
    AuthResponse:
      type: object
      properties:
        accessToken:
          type: string
        tenantId:
          type: string
        userId:
          type: string
    UserCertificateResponse:
      type: object
      properties:
        certificatePem:
          type: string
        fingerprint:
          type: string
        serial:
          type: string
        subject:
          type: string
        issuer:
          type: string
        validFrom:
          type: string
        validTo:
          type: string
        revokedAt:
          type: string
          nullable: true
        revokedReason:
          type: string
          nullable: true
    TenantInfoResponse:
      type: object
      properties:
        tenant:
          $ref: "#/components/schemas/TenantInfo"
    TenantInfo:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        slug:
          type: string
    MeResponse:
      type: object
      properties:
        profile:
          type: object
          properties:
            userId:
              type: string
            name:
              type: string
            email:
              type: string
              format: email
        tenant:
          $ref: "#/components/schemas/TenantInfo"
        membership:
          type: object
          properties:
            role:
              type: string
            isOwner:
              type: boolean
            joinedAt:
              type: string
              format: date-time
    DocumentSignResponse:
      type: object
      properties:
        documentId:
          type: string
        chainId:
          type: string
        versionNumber:
          type: integer
        verificationUrl:
          type: string
          format: uri
        signedPdfDownloadUrl:
          type: string
          format: uri
        signedPdfSha256:
          type: string
        signature:
          $ref: "#/components/schemas/Signature"
        tsa:
          $ref: "#/components/schemas/Tsa"
        ltv:
          $ref: "#/components/schemas/Ltv"
        signers:
          type: array
          items:
            $ref: "#/components/schemas/Signer"
    DocumentShowResponse:
      type: object
      properties:
        documentId:
          type: string
        chainId:
          type: string
        latestVersion:
          $ref: "#/components/schemas/DocumentVersionSummary"
        signers:
          type: array
          items:
            $ref: "#/components/schemas/Signer"
    DocumentVersionsResponse:
      type: object
      properties:
        documentId:
          type: string
        chainId:
          type: string
        versions:
          type: array
          items:
            $ref: "#/components/schemas/DocumentVersionSummary"
    DocumentVersionSummary:
      type: object
      properties:
        versionNumber:
          type: integer
        signedPdfSha256:
          type: string
        signedPdfDownloadUrl:
          type: string
          format: uri
        signedAt:
          type: string
          format: date-time
    VerifyResponse:
      oneOf:
        - $ref: "#/components/schemas/VerifyValidResponse"
        - $ref: "#/components/schemas/VerifyInvalidResponse"
    VerifyValidResponse:
      allOf:
        - $ref: "#/components/schemas/DocumentSignResponse"
        - type: object
          properties:
            valid:
              type: boolean
              example: true
            signatureValid:
              type: boolean
              nullable: true
            certificateStatus:
              type: string
              example: valid
            rootCaFingerprint:
              type: string
              nullable: true
            certificateRevokedAt:
              type: string
              nullable: true
            certificateRevokedReason:
              type: string
              nullable: true
            tsaStatus:
              type: string
              example: valid
            tsaSignedAt:
              type: string
              nullable: true
            tsaFingerprint:
              type: string
              nullable: true
            tsaReason:
              type: string
              nullable: true
            ltvStatus:
              type: string
              example: ready
            ltvGeneratedAt:
              type: string
              nullable: true
            ltvIssues:
              type: array
              items:
                type: string
    VerifyInvalidResponse:
      type: object
      properties:
        valid:
          type: boolean
          example: false
        reason:
          type: string
          example: hash_not_found
        signedPdfSha256:
          type: string
        expectedSignedPdfSha256:
          type: string
          nullable: true
    Signature:
      type: object
      nullable: true
      properties:
        algorithm:
          type: string
        certificateFingerprint:
          type: string
        certificateSubject:
          type: string
        certificateSerial:
          type: string
    Tsa:
      type: object
      nullable: true
      properties:
        signedAt:
          type: string
          nullable: true
        fingerprint:
          type: string
          nullable: true
        algorithm:
          type: string
          nullable: true
    Ltv:
      type: object
      nullable: true
      properties:
        enabled:
          type: boolean
        generatedAt:
          type: string
          nullable: true
        rootCaFingerprint:
          type: string
          nullable: true
        tsaFingerprint:
          type: string
          nullable: true
    Signer:
      type: object
      properties:
        index:
          type: integer
        tenantId:
          type: string
        userId:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
        signedAt:
          type: string
          format: date-time
        certificate:
          $ref: "#/components/schemas/SignerCertificate"
    SignerCertificate:
      type: object
      properties:
        serial:
          type: string
        issuedBy:
          type: string
        validFrom:
          type: string
        validTo:
          type: string
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
    ValidationError:
      type: object
      properties:
        message:
          type: string
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
